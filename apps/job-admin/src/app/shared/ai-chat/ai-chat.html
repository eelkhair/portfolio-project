<!-- Floating button -->
<button
  class="chat-fab"
  (click)="toggle()"
  [class.chat-fab-open]="isOpen()">
  @if (isOpen()) {
    <i class="pi pi-times"></i>
  } @else {
    <i class="pi pi-sparkles"></i>
    <span class="chat-fab-label">AI Chat</span>
  }
</button>

<!-- Chat window -->
@if (isOpen()) {
  <aside class="chat-window">
    <div class="chat-header">
      <i class="pi pi-sparkles"></i>
      <span>AI Assistant</span>
    </div>

    <div class="chat-messages" #messagesContainer>
      @for (msg of store.messages(); track $index) {
        <div class="chat-message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'">
          @if (msg.html) {
            <div class="message-content" [innerHTML]="msg.html"></div>
          } @else {
            <div class="message-content">{{ msg.content }}</div>
          }
          <div class="message-footer">
            <span class="message-time">{{ msg.time }}</span>
            @if (store.showJaeger() && msg.duration) {
              <span class="duration-label">{{ msg.duration }}</span>
            }
            @if (store.showJaeger() && msg.traceId) {
              <div class="trace-links">
                <a class="trace-link grafana"
                   [href]="'https://grafana.eelkhair.net/d/bf5m5dwukfncwd/find-by-trace-id?orgId=1&var-TraceId=' + msg.traceId"
                   target="_blank"
                   rel="noopener"
                   title="View trace in Grafana">
                  <i class="pi pi-external-link"></i> <span class="trace-label">view in grafana</span>
                </a>
                <a class="trace-link"
                   [href]="'https://jaeger.eelkhair.net/trace/' + msg.traceId"
                   target="_blank"
                   rel="noopener"
                   title="View trace in Jaeger">
                  <i class="pi pi-external-link"></i> <span class="trace-label">view in jaeger</span>
                </a>
              </div>
            }
          </div>
        </div>
      }
      @if (store.loading()) {
        <div class="chat-message assistant">
          <div class="message-content typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </div>
      }
    </div>

    @if (store.jaegerNotification()) {
      <div class="jaeger-notification">{{ store.jaegerNotification() }}</div>
    }

    <div class="chat-input">
      <textarea
        #chatInput
        pInputText
        [(ngModel)]="message"
        placeholder="Type a message..."
        (keydown)="onKeydown($event)"
        [disabled]="store.loading()"
        rows="3"
        class="w-full"></textarea>
      <p-button
        icon="pi pi-send"
        (onClick)="send()"
        [disabled]="!message.trim() || store.loading()">
      </p-button>
    </div>
  </aside>
}
