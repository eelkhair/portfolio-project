<!-- Floating button -->
<button
  class="chat-fab"
  (click)="toggle()"
  [class.chat-fab-open]="isOpen()">
  @if (isOpen()) {
    <i class="pi pi-times"></i>
  } @else {
    <i class="pi pi-sparkles"></i>
    <span class="chat-fab-label">AI Chat</span>
  }
</button>

<!-- Chat window -->
@if (isOpen()) {
  <aside class="chat-window">
    <div class="chat-header">
      <i class="pi pi-sparkles"></i>
      <span>AI Assistant</span>
    </div>

    <div class="chat-messages" #messagesContainer>
      @for (msg of messages(); track $index) {
        <div class="chat-message" [class.user]="msg.role === 'user'" [class.assistant]="msg.role === 'assistant'">
          @if (msg.html) {
            <div class="message-content" [innerHTML]="msg.html"></div>
          } @else {
            <div class="message-content">{{ msg.content }}</div>
          }
          @if (showJaeger() && (msg.duration || msg.traceId)) {
            <div class="message-footer">
              @if (msg.duration) {
                <span class="duration-label">{{ msg.duration }}</span>
              }
              @if (msg.traceId) {
                <a class="trace-link"
                   [href]="'https://jaeger.eelkhair.net/trace/' + msg.traceId"
                   target="_blank"
                   rel="noopener"
                   title="View trace in Jaeger">
                  <i class="pi pi-external-link"></i> <span class="trace-label">view in jaeger</span>
                </a>
              }
            </div>
          }
        </div>
      }
      @if (loading()) {
        <div class="chat-message assistant">
          <div class="message-content typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </div>
      }
    </div>

    <div class="chat-input">
      <textarea
        #chatInput
        pInputText
        [(ngModel)]="message"
        placeholder="Type a message..."
        (keydown)="onKeydown($event)"
        [disabled]="loading()"
        rows="3"
        class="w-full"></textarea>
      <p-button
        icon="pi pi-send"
        (onClick)="send()"
        [disabled]="!message.trim() || loading()">
      </p-button>
    </div>
  </aside>
}
