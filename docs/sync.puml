@startuml
title Company Creation – Connector-Orchestrated Saga (Annotated)

autonumber
skinparam responseMessageBelowArrow true
skinparam noteBackgroundColor #FDF6E3
skinparam noteBorderColor #657B83

actor "Frontend" as FE

participant "Monolith API\n(Command)" as Monolith
database "Monolith DB\n(SQL Server)" as MonolithDb

participant "Outbox Processor\n(Timer)" as Outbox
participant "Dapr / PubSub" as PubSub

participant "Connector API\n(Saga Orchestrator)" as Connector
database "Idempotency Store" as Idempotency

participant "Company API" as CompanyApi
participant "User API" as UserApi
participant "Job API" as JobApi

participant "Monolith API\n(Activation)" as MonolithAct
participant "SignalR Hub" as SignalR

note right of FE
Frontend only talks to the Monolith.
No microservice knowledge,
no event awareness.
end note

== Create Company ==

FE -> Monolith: POST /companies
activate Monolith

note right of Monolith
Command-side responsibility:
• Validate invariants
• Enforce business rules
• Own transactional consistency
end note

Monolith -> MonolithDb: Validate + INSERT Company/User
Monolith -> MonolithDb: INSERT outbox(company.created)

note right of MonolithDb
Company + outbox record
are committed in the SAME transaction.
This guarantees no lost events.
end note

MonolithDb --> Monolith: Commit
Monolith --> FE: 201 Created
deactivate Monolith

== Outbox Publish ==

Outbox -> MonolithDb: Poll outbox
MonolithDb --> Outbox: company.created event

note right of Outbox
Outbox processor is time-decoupled.
Failure here does NOT break
the user request.
end note

Outbox -> PubSub: Publish company.created
PubSub --> Outbox: ack
Outbox -> MonolithDb: Mark outbox processed

== Connector Picks Up Event ==

PubSub -> Connector: company.created
activate Connector

note right of Connector
Connector is NOT a domain owner.
It orchestrates cross-system workflows
and owns saga coordination.
end note

Connector -> Idempotency: Check message id

note right of Idempotency
Idempotency guarantees:
• At-least-once delivery safety
• Retry without duplication
end note

Idempotency --> Connector: Not processed
Connector -> Idempotency: Record message id

== Saga: Microservices Fanout ==

note over Connector,CompanyApi
Each microservice is autonomous:
• Owns its own database
• No shared transactions
• Reacts to events only
end note

Connector -> CompanyApi: Create Company (event)
activate CompanyApi
CompanyApi --> Connector: OK
deactivate CompanyApi

Connector -> UserApi: Create User (event)
activate UserApi
UserApi --> Connector: OK
deactivate UserApi

Connector -> JobApi: Initialize Jobs Context
activate JobApi
JobApi --> Connector: OK
deactivate JobApi

== Saga Completion ==

note right of Connector
Only AFTER all participants succeed
does the saga advance.
end note

Connector -> MonolithAct: POST /companies/{id}/activate
activate MonolithAct

note right of MonolithAct
Activation is a BUSINESS decision,
not a side effect of creation.
end note

MonolithAct -> MonolithDb: UPDATE Company.Status = Active
MonolithDb --> MonolithAct: OK

MonolithAct -> SignalR: CompanyActivated

note right of SignalR
Realtime feedback to the user
only after the system
is fully consistent.
end note

SignalR --> FE: realtime ack
deactivate MonolithAct
deactivate Connector

@enduml
